ASQ<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="asq-confidence.html">
<link rel="import" href="asq-progress.html">
<link rel="import" href="../asq-base/asq-base.html">

<!--
`asq-exercise` is the container for all ASQ `question types`. It can contain several `ASQ questions`. It is the one that can communicate(submit answers) with server side.

##### Example
    <asq-exercise exerciseid="ex1" class="exercise">
      <asq-stem><h2>Exercise 1</h2></asq-stem>
      <asq-multi-choice>
        <asq-stem><h3>Which are the official languages of Switzerland?</h3></asq-stem>
        <asq-option>English</asq-option>
        <asq-option correct-answer="true">French</asq-option>
        <asq-option correct-answer="true">German</asq-option>
        <asq-option correct-answer="true">Rumantsch</asq-option>
      </asq-multi-choice>
    </asq-exercise>

Different users will see different UI according to their `role`. There are three types of roles, `viewer`, `presenter` and `teaching assistant`.

@element asq-exercise
@group ASQ Elements
@blurb Element Container for all ASQ `question types`.
@homepage http://github.com/ASQ_USI/asq-exercise
-->
<polymer-element name="asq-exercise" attributes="confidence">
  <template>
    <style> 

      :host{
        display: block;
      }
   
      .submit-button {
        color: #fff;
        background-color: #5cb85c;
      }
      .disabled-button {
        background-color: #817E7E;
      }
      .edit-button {
        color: #fff;
        background-color: rgb(255, 155, 15);
      }

      asq-progress::shadow paper-progress::shadow #activeProgress {
        background-color: #5C87B8;
      }
     
    </style>

    <template if="{{role==roles.VIEWER}}">
      <article class="asq-exercise">
        <div>
          <content select="asq-stem"></content>
        </div>
        <div>
          <content></content>
        </div>
        <footer horizontal end-justified layout>
          <div>
            <template if="{{confidence}}">
            <asq-confidence id="confidence"></asq-confidence>
            </template>
            <paper-button id="submit_button" class="submit-button" on-tap="{{submit}}" raised="true">Submit</paper-button>
            <paper-button id="edit_button"  class="edit-button" on-tap="{{edit}}" raised="true">Edit</paper-button> 
          </div>   
        </footer>
      </article>
    </template>


    <template if="{{role==roles.PRESENTER}}">
      <article class="asq-exercise">
        <div>
          <content select="asq-stem"></content>
        </div>
        <div>
          <content></content>
        </div>
        <footer horizontal end-justified layout>
          <div>
            <asq-progress value="{{submissionsNum}}" max="{{connectedViewersNum}}"></asq-progress>
            <paper-button id="stats" class="submit-button" raised="true">Stats</paper-button>
          </div>
        </footer>
      </article>
    </template> 

    <template if="{{role==roles.TA}}">
      <article class="asq-exercise">
        <div>
          <content select="asq-stem"></content>
        </div>
        <div>
          <content></content>
        </div>
        <footer horizontal end-justified layout>
          <div>
            <asq-progress></asq-progress>
          </div>
        </footer>
      </article>
    </template> 

  </template>

  <script>
    (function() {

      var p = {

      /**
       * Display confidence stars in the exercise
       *
       * @attribute confidence
       * @type Boolean
       * @default false
       */
        confidence: false,

        connectedViewersNum: 0,

        submissions: 0, 

        created: function(){
          document.addEventListener('asq-ready', function(evt){
            try{
              this.subscribeToEvents(evt.detail.asqEventBus)
            }catch(err){
              console.debug('failed to subscribeToEvents');
            }
          }.bind(this));
        },

        /**
         * Exercise is interested in two events: `asq:question_type`, which is emitted 
         * when answer is submitted successfully, and `asq:question_type_edit`, which is emitted
         * when editing answer.
         *
         */
        subscribeToEvents: function(eventBus){
          eventBus.on('asq:question_type', this.onQuestionType.bind(this));
          eventBus.on('asq:connected-clients', this.onConnectedClients.bind(this));
        },

        onQuestionType: function(evt){
          if(evt && evt.questionType && evt.questionType == 'asq-exercise'){
            if(evt.type == "progress"){
              this.onProgress(evt)
            }
          }
        },

        onProgress: function(evt){
          if(evt.exerciseUid !== this.uid) return;
          if(this.role !== this.roles.PRESENTER) return;
          this.updateProgress(evt.submissions);
        },

        updateProgress: function(submissions){
          this.submissionsNum = submissions.length;
        },

        onConnectedClients: function(event){
          if(this.role !== this.roles.PRESENTER) return;
          this.connectedViewersNum = event.connectedViewers.length;
        },

        /**
         * The `asq-submit` event is fired whenever function `submit` is called.
         *
         * @event asq-submit
         * @param {Object} detail
         *   @param {Object} detail.submission The submission.
         *     @param {String} detail.submission.confindence The confindence.
         *     @param {Object} detail.submission.answers All the answers in JSON format.
         */
        /**
         * The `submit` method will submit the answer to a wrapped 'asq-exercise' instance. 
         * <br>
         * Only useful when the `role` is <b>viewer</b>.
         *
         * @method submit
         */
        submit: function() {
          if ( this.role !== this.roles.VIEWER ) {
            return;
          }

          var questions = this.getQuestions();

          var answers = this.getAnswers();

          //submitted confidence will be null if not this.confidence is false
          var confidence;

          if(this.confidence){
            confidence = this.shadowRoot.getElementById('confidence').getConfidenceLevel();
          }

          this.toggleSubmit();

          console.log("client submits submission");
          this.fire('asq-submit', {
            submission: {
              answers: answers,
              confidence: confidence
            }
          });
          
        },

        /**
         * Get all questions inside this exercise.
         *
         * @method getQuestions
         */
        getQuestions: function() {
          return this.childNodes.array().filter(function(el) {
            return el.isASQElement && el.isASQQuestionTypeElement;
          });
        },

        /**
         * Get all answers of all questions.
         *
         * @method getAnswers
         */
        getAnswers: function() {
          var questions = this.getQuestions();
          var answers = [];
          questions.forEach(function(elem, index) {
            answers.push(elem.submit());
          });
          return answers;
        },

        /**
         * The `asq-edit-submission` event is fired whenever function `edit` is called.
         *
         * @event asq-edit-submission
         * @param {Object} detail
         *   @param {Object} detail.submission The submission.
         *     @param {Object} detail.submission.answers All the answers in JSON format.
         */
        /**
         * The `edit` method will allow student to modify the answers. 
         * <br>
         * Only useful when the `role` is <b>viewer</b>.
         *
         * @method edit
         */
        edit: function() {
          if ( this.$.submit_button.disabled ) {
            console.log("client edits submission", this.getAnswers());
            this.toggleSubmit();
            this.fire('asq-edit-submission', {
              submission: {
                answers: this.getAnswers()
              }
            });
            
          }
        },

        toggleSubmit: function() {
          if ( this.$.submit_button.disabled ) {
            this.$.submit_button.disabled = false;
            this.$.submit_button.classList.remove("disabled-button");
          } else {
            this.$.submit_button.disabled = true;
            this.$.submit_button.classList.add("disabled-button");
          }
        },
      }
      
      //we use a custom mixin to avoid overwriting published properties of the prototype
      ASQ.asqify(p);
      Polymer('asq-exercise', p);

    })();
  </script>
</polymer-element>
