ASQ<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="asq-confidence.html">
<link rel="import" href="asq-progress.html">
<link rel="import" href="../asq-base/asq-base.html">


<polymer-element name="asq-exercise" attributes="exerciseid" >
  <template>
    <style> 

      :host{
        display: block;
      }
   
      .submit-button {
        color: #fff;
        background-color: #5cb85c;
      }
      .disabled-button {
        background-color: #817E7E;
      }
      .edit-button {
        color: #fff;
        background-color: rgb(255, 155, 15);
      }
     
    </style>

    <template if="{{role==roles.VIEWER}}">
      <article id="ex" class="asq-exercise">
        <div>
          <content select="asq-stem"></content>
        </div>
        <div id="exercises">
          <content></content>
        </div>
        <footer id="buttons" horizontal end-justified layout>
          <div>
            <asq-confidence id="confidence"></asq-confidence>
            <paper-button id="submit_button" class="submit-button" on-tap="{{submit}}" raised="true">Submit</paper-button>
            <paper-button id="edit_button"  class="edit-button" on-tap="{{edit}}" raised="true">Edit</paper-button> 
          </div>   
        </footer>
      </article>
    </template>


    <template if="{{role==roles.PRESENTER}}">
      <article id="ex" class="asq-exercise">
        <div>
          <content select="asq-stem"></content>
        </div>
        <div id="exercises">
          <content></content>
        </div>
        <footer id="buttons" horizontal end-justified layout>
          <div>
            <asq-progress></asq-progress>
            <paper-button id="stats" class="submit-button" raised="true">Stats</paper-button>
          </div>
        </footer>
      </article>
    </template> 

    <template if="{{role==roles.TA}}">
      <article id="ex" class="asq-exercise">
        <div>
          <content select="asq-stem"></content>
        </div>
        <div id="exercises">
          <content></content>
        </div>
        <footer id="buttons" horizontal end-justified layout>
          <div>
            <asq-progress></asq-progress>
          </div>
        </footer>
      </article>
    </template> 

  </template>

  <script>
    (function() {

      var p = {
        exerciseid: 0,

        // created: function(){
        //   document.addEventListener('asq-ready', function(evt){
        //     try{
        //       this.subscribeToEvents(evt.detail.asqEventBus)
        //     }catch(err){
        //       console.debug('failed to subscribeToEvents');
        //     }
        //   }.bind(this));
        // },

        submit: function() {
          if ( this.role !== this.roles.VIEWER ) {
            return;
          }

          var questions = this.childNodes.array().filter(function(el) {
            return el.isASQElement && el.isASQQuestionTypeElement;
          });

          console.log("questions ", questions);

          var answers = [];
          questions.forEach(function(elem, index) {
            answers.push(elem.submit());
          });

          var confidence = this.$.confidence.getConfidenceLevel();

          this.toggleSubmit();

          this.fire('asq-submit', {
            submission: {
              answers: answers,
              confidence: confidence
            }
          });
        },

        edit: function() {
          this.toggleSubmit();
        },

        toggleSubmit: function() {
          if ( this.$.submit_button.disabled ) {
            this.$.submit_button.disabled = false;
            this.$.submit_button.classList.remove("disabled-button");
          } else {
            this.$.submit_button.disabled = true;
            this.$.submit_button.classList.add("disabled-button");
          }
        },
      }
      
      //we use a custom mixin to avoid overwriting published properties of the prototype
      ASQ.asqify(p);
      Polymer('asq-exercise', p);

    })();
  </script>
</polymer-element>
