<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../asq-base/asq-base.html">
<link rel="import" href="asq-exercise-progress-style.html">

<dom-module id="asq-exercise-progress">
  <template>
    <style include="iron-flex">
      :host {
        display: block;
        position: relative;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin: 10px 0 5px 0;
      }
    </style>

    <style include="asq-exercise-progress-style"></style>

    <div class="progress-bar-container background-progress">
      <paper-progress id="background-submitted-progress" indeterminate style$=[[_calcFlex(submissionsNum)]]></paper-progress>
      <paper-progress id="background-working-progress" indeterminate style$=[[_calcFlex(_workingUsersNum)]]></paper-progress>
      <paper-progress id="background-focused-progress" indeterminate style$=[[_calcFlex(_focusedUsersNum)]]></paper-progress>
      <paper-progress id="background-idle-progress" indeterminate style$=[[_calcFlex(_idleUsersNum)]]></paper-progress>
    </div>

    <div class="progress-bar-container">
      <paper-progress id="submitted-progress" value="100" style$=[[_calcFlex(submissionsNum)]]></paper-progress>
      <paper-progress id="working-progress" value="100" style$=[[_calcFlex(_workingUsersNum)]]></paper-progress>
      <paper-progress id="focused-progress" value="100" style$=[[_calcFlex(_focusedUsersNum)]]></paper-progress>
      <paper-progress id="idle-progress" value="100" style$=[[_calcFlex(_idleUsersNum)]]></paper-progress>
    </div>

    <div id="progress-num">
      <span>[[submissionsNum]]</span>
      <span>/</span>
      <span>[[connectedViewersNum]]</span>
    </div>

  </template>

  <script>

  Polymer({

    is: 'asq-exercise-progress',

    behaviors: [ASQ.asqElementBehavior],

    properties: {

      _users: {
        type: Object,
        value: {},
      },

      connectedViewersNum: {
        type: Number,
        notify: true,
        value: 0,
      },

      submissionsNum: {
        type: Number,
        value: 0,
      },

      _submissionCounter: {
        type: Number,
        value: 0,
      },

      _workingUsersNum:{
        type: Number,
        value: 0,
        computed: '_computeWorkingUsersNum(_users)',
      },

      _workingCounter: {
        type: Number,
        value: 0,
      },

     _focusedUsersNum:{
        type: Number,
        value: 0,
        computed: '_computeFocusedUsersNum(_users)',
     },

     _focusedCounter: {
       type: Number,
       value: 0,
     },

     _idleUsersNum:{
        type: Number,
        value: 0,
        computed: '_computeIdleUsersNum(_users)',
     },

     _idleCounter: {
       type: Number,
       value: 0,
     },

    },

    _computeWorkingUsersNum: function() {
      let users = this._users;
      let num = Object.keys(users).reduce(function(acc, userId) {
        if(users[userId].working) return ++acc;
        return acc;
      }, 0);
      return num;
    },

    _computeFocusedUsersNum: function() {
      let users = this._users;
      return Object.keys(users).reduce(function(acc, userId) {
        if(users[userId].focused && !users[userId].idle) return ++acc;
        return acc;
      }, 0);
    },

    _computeIdleUsersNum: function() {
      let users = this._users;
      return Object.keys(users).reduce(function(acc, userId) {
        if(users[userId].idle || users[userId].disconnected) return ++acc
        return acc;
      }, 0);
    },

    _calcFlex: function(num) {
      return "flex:" + num + ";";
    },

    _makeSureUserExists: function(userToFind) {
      this._users[userToFind.id] = this._users[userToFind.id] || userToFind;
      this._notifyPolymer();
    },

    _userWorked: function(user) {
      this._makeSureUserExists(user);
      if (!this._users[user.id].working) this._workingCounter++;
      this._resetUser(user);
      this._users[user.id].working = true;
      this._notifyPolymer();
    },

    _userFocused: function(user) {
      this._makeSureUserExists(user);
      if (this._users[user.id].submitted) return;
      if (!this._users[user.id].focused) this._focusedCounter++;
      this._resetUser(user);
      this._users[user.id].focused = true;
      this._notifyPolymer();
    },

    _userMadeTabVisible: function(user) {
      this._makeSureUserExists(user);
      this._users[user.id].idle = false;
      this._notifyPolymer();
    },

    _userIdled: function(user) {
      this._makeSureUserExists(user);
      if (this._users[user.id].submitted) return;
      if (!this._users[user.id].idle) this._idleCounter++;
      this._resetUser(user);
      this._users[user.id].idle = true;
      this._notifyPolymer();
    },

    _userMadeTabHidden: function(user) {
      this._makeSureUserExists(user);
      this._users[user.id].idle = false;
      this._notifyPolymer();
    },

    _userBlurred: function(user) {
      this._makeSureUserExists(user);
    },

    _resetUser: function(user) {
      this._users[user.id].submitted = false;
      this._users[user.id].working = false;
      this._users[user.id].focused = false;
      this._users[user.id].idle = false;
    },

    _userSubmitted: function(user) {
      this._makeSureUserExists(user);
      this._resetUser(user);
      this._users[user.id].submitted = true;
      this._submissionCounter++;
    },

    _userConnected: function() {
      this.connectedViewersNum++;
    },

    _userDisconnected: function() {
      this.connectedViewersNum--;
    },

    _notifyPolymer: function() {
      _users = this._users;
      this._users = {};
      this._users = _users;
    },

    _setVelocity:  function(property, velocity) {
      let that = this;
      this.customStyle[property] = velocity + 's';
      this.updateStyles();
      setTimeout(function() {
        that.customStyle[property] = '0s';
        that.updateStyles();
      }, velocity * 1000);
    },

    _visualizeChange: function() {
      let that = this;

      setInterval(function() {
        let submissionChange = that._calcChange(that._submissionCounter);
        let workingChange = that._calcChange(that._workingCounter);
        let focusedChange = that._calcChange(that._focusedCounter);
        let idleChange = that._calcChange(that._idleCounter);

        that._setVelocity('--submitted-bar-duration', that._determineVelocity(submissionChange));
        that._setVelocity('--working-bar-duration',  that._determineVelocity(workingChange));
        that._setVelocity('--focused-bar-duration',  that._determineVelocity(focusedChange));
        that._setVelocity('--idle-bar-duration',  that._determineVelocity(idleChange));

        that._submissionCounter = 0;
        that._workingCounter = 0;
        that._focusedCounter = 0;
        that._idleCounter = 0;
      }, 5000);
    },

    _calcChange: function(num) {
      let total = this.submissionsNum + this._workingUsersNum + this._focusedUsersNum + this._idleUsersNum;
      return num/total * 100;
    },

    _determineVelocity: function(num) {
      if (num == 0) return 0;
      else if(num < 5) return 10;
      else if(num < 15) return 8;
      else if(num < 30) return 6;
      else if(num < 50) return 4;
      else if(num < 75) return 2;
      else if(num <= 100) return 1;
      else return 0 // change was higher than 100%
    },

    created: function() {
      document.addEventListener('asq-ready', function(evt) {
        try {
          this._subscribeToEvents(evt.detail.asqEventBus);
        } catch (err) {
          console.debug('failed to _subscribeToEvents');
        }
      }.bind(this));
      this._visualizeChange();
    },

    _subscribeToEvents: function(eventBus) {
      let that = this;
      eventBus.on('asq:sessionEventBeamer', function(evt) {
        const user = evt.data.sessionEvent.user;

        switch (evt.data.sessionEvent.type) {
          case 'folo-connected':
          case 'ghost-connected':
            return that._userConnected();
          case 'folo-disconnected':
          case 'ghost-disconnected':
            return that._userDisconnected();
          case 'answer-submitted':
            return that._userSubmitted(evt.data.sessionEvent.answeree);
          case 'viewer-idle':
            return that._userIdled(user);
          case 'questioninput':
          case 'copy':
          case 'paste':
          case 'cut':
          case 'input':
            return that._userWorked(user);
          case 'tabvisible':
            return that._userMadeTabVisible(user);
          case 'tabhidden':
            return that._userMadeTabHidden(user);
          case 'focusin':
          case 'exercisefocus':
          case 'windowfocus':
            return that._userFocused(user);
          case 'exerciseblur':
          case 'windowblur':
            return that._userBlurred(user);
        }
      });
    },

  });

  </script>

</dom-module>
